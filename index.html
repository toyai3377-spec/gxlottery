<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gx lottery+ ‚Äî ‡πÅ‡∏ó‡∏á‡∏´‡∏ß‡∏¢ & ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (LIVE FIREBASE DB)</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
/* --- MODIFIED: NEON BLUE / CYBERPUNK THEME --- */
:root{
  --bg-dark:#09091A;       /* Darker Blue-Black for BG */
  --bg-medium:#151838;     /* Dark Blue for BG gradient end */
  --bg-light:#2A3258;      /* Lighter Blue for structural elements */
  --card-bg:#1A2040;       /* Dark Blue for card backgrounds */
  --accent-light:#00FFFF;  /* Electric Cyan (Primary Accent) */
  --accent-dark:#00BFFF;   /* Deep Sky Blue (Secondary Accent) */
  --text-main:#E0F7FA;     /* Light Aqua-White for main text */
  --text-muted:#9BB5D0;    /* Muted Blue-Grey */
  --border-color:rgba(0,255,255,0.3); /* Transparent Cyan border */
  --input-bg:#10142A;      /* Very Dark Blue for inputs */
  --glass: rgba(255,255,255,0.05); 
  --balance-color:#ffe066; /* Yellow/Gold for balance */
  --deposit-btn-start:#4ade80; /* Electric Green for deposit (Success) */
  --deposit-btn-end:#16a34a;   /* Darker Green */
  --withdraw-btn-start:#ef4444; /* Red for withdraw (Danger) */
  --withdraw-btn-end:#cc3333;
  --danger:#ef4444; 
  --modern-shadow: 0 10px 30px rgba(0,0,0,0.7); 
}
/* --- END MODIFIED: NEON BLUE / CYBERPUNK THEME --- */

*{box-sizing:border-box;font-family:Inter,sans-serif}
html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,var(--bg-dark) 0%, var(--bg-medium) 100%);
    color:var(--text-main);
    font-size:16px
}
/* Layout for Mobile First */
.wrap{max-width:960px;margin:0 auto;padding:20px 10px}
.main-content{display:flex;flex-direction:column;gap:20px}
.lotto-panel{flex:1}
.sidebar{width:100%}

@media (min-width: 768px) {
  .wrap{padding:40px 20px}
  .main-content{flex-direction:row;gap:30px}
  .sidebar{width:300px}
}

.card{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--modern-shadow);color:var(--text-main)}

input[type=text],input[type=password],input[type=number],select{
    width:100%;
    padding:14px;
    min-height: 50px;
    font-size: 1.1em;
    border-radius:8px;
    border:1px solid var(--border-color);
    background:var(--input-bg);
    color:var(--text-main);
    margin-top:10px;
}

button{
  background:var(--accent-light); 
  color:var(--bg-dark); 
  padding:12px 15px;
  border-radius:8px;
  border:0;
  cursor:pointer;
  margin-top:12px;
  width:100%;
  font-weight:600;
  transition:opacity 0.2s, background 0.2s; 
}
button:hover:not(:disabled){opacity:0.9; background: var(--accent-dark); color: white;}
button:disabled{opacity:0.5;cursor:not-allowed}

.contact-link{
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-main);
    padding: 12px 15px;
    border-radius: 8px;
    display: inline-block;
    text-align: center;
    text-decoration: none;
    margin-top: 12px;
    width: 100%;
    font-weight: 600;
}
.contact-link:hover{opacity:0.9; background: var(--card-bg);}

button.ghost{background:transparent;border:1px solid var(--border-color);color:var(--text-main)}
button.danger{background:var(--danger);color:white}
button.success{background:linear-gradient(180deg,var(--deposit-btn-start),var(--deposit-btn-end));color:var(--bg-dark);}
button#adminPanelBtn{
    background: linear-gradient(180deg, var(--withdraw-btn-start), var(--withdraw-btn-end));
    color:white;
}
button#adminPanelBtn:hover{
    opacity:0.9;
    background: var(--withdraw-btn-start);
}

.small{font-size:14px;color:var(--text-muted)}
.hidden{display:none}

/* Lottery specific styles */
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:20px}
.keypad button{
  padding:18px 0;
  background: linear-gradient(145deg, var(--bg-medium), var(--bg-light));
  color:var(--text-main);
  font-size:24px;
  border:1px solid rgba(255,255,255,0.2);
  border-radius:12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  transition:background 0.3s, box-shadow 0.3s, border-color 0.3s; 
  position:relative;
  overflow:hidden;
}
.keypad button:hover:not(:disabled){
  background: linear-gradient(145deg, var(--bg-light), var(--bg-medium));
  border-color: var(--accent-light);
  box-shadow:0 0 25px rgba(0,255,255,0.7), 0 0 10px rgba(0,255,255,0.5);
}

/* Modal Styling */
.modal{
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.8);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:1000;
    opacity:0;
    visibility:hidden;
    transition:opacity 0.3s, visibility 0.3s;
}
.modal.visible{opacity:1;visibility:visible}
.modal-content{
    background:var(--card-bg);
    padding:30px;
    border-radius:12px;
    max-width:400px;
    width:90%;
    box-shadow:var(--modern-shadow);
    text-align:center;
}
.qr-code{
    background:white;
    padding:20px;
    border-radius:8px;
    margin:15px auto;
    width:200px;
    height:200px;
    display:flex;
    justify-content:center;
    align-items:center;
}

/* Cart Specific */
#cartList .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border-color)}
#cartList .cart-item:last-child{border-bottom:none}
#cartTotalArea{padding-top:15px;margin-top:10px;border-top:1px solid var(--border-color);font-size:1.1em;font-weight:700;display:flex;justify-content:space-between}
#removeCartItem{width:auto;padding:5px 10px;margin:0;font-size:12px}
.tx-list{max-height:200px;overflow-y:auto;margin-top:12px;background:var(--glass);padding:10px;border-radius:8px}
.tx-item{
    padding:8px 0;
    border-bottom:1px solid rgba(255,255,255,0.05);
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
}
.tx-item:last-child{border-bottom:none}
.status-badge{padding:2px 6px;border-radius:4px;font-size:12px;font-weight:600}
.pending{background:#fbbf24;color:#0a1811}
.win{background:#72ed9a;color:#0a1811}
.lose{background:#ef4444;color:#fff}
.pending-admin{background:#fbbf24;color:#0a1811}

/* Login Card - NEW MODERN STYLE */
#loginCard{
  max-width:400px;
  margin:100px auto;
  padding:30px; 
  background: var(--card-bg); 
  backdrop-filter: blur(5px); 
  border: 1px solid var(--border-color); 
  border-radius: 18px; 
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
  position: relative; 
  z-index: 10;
}
#loginCard::before {
    content: '';
    position: absolute;
    inset: -2px; 
    border-radius: 20px;
    padding: 2px;
    /* Neon Cyan Border Glow */
    background: linear-gradient(45deg, var(--accent-light), var(--accent-dark), var(--accent-light));
    -webkit-mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    z-index: -1;
    opacity: 0.8;
}

#loginCard h2{
  text-align:center;
  margin-bottom:25px;
  color:var(--accent-light);
  text-shadow: 0 0 8px rgba(0,255,255,0.8), 0 0 15px rgba(0,255,255,0.4);
  letter-spacing: 1px;
}

.login-register-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 25px; 
}
@media (min-width: 480px) { 
    .login-register-buttons {
        flex-direction: row; 
    }
}

.login-register-buttons button,
.login-register-buttons a.register-btn {
    flex: 1; 
    background: var(--accent-light);
    color: var(--bg-dark);
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    box-shadow: var(--modern-shadow);
    font-size: 1em;
    font-weight: 600; 
    text-decoration: none; 
    display: flex; 
    justify-content: center;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease-in-out;
    margin-top: 0 !important;
}

.login-register-buttons button:hover,
.login-register-buttons a.register-btn:hover {
    background: var(--accent-dark);
    color: white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.7);
    transform: none;
}
button#loginBtn {
    margin-top: 0; 
    background: linear-gradient(180deg, #1084D0 0%, #0D6EB3 100%);
    color: white;
    border: 1px solid var(--accent-light);
}
button#loginBtn:hover {
    background: linear-gradient(180deg, #2495E4 0%, #1084D0 100%); 
}

.login-register-buttons a.register-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-main);
}
.login-register-buttons a.register-btn:hover {
    background: var(--input-bg);
}
</style>
</head>
<body>

<script>
(function () {
    const ua = navigator.userAgent;
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö In-App Browser ‡∏Ç‡∏≠‡∏á LINE, TikTok, Facebook/Messenger
    const isProblematicApp = /Line|TikTok|FBAV|FBAN|Messenger/i.test(ua);
    
    if (isProblematicApp) {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        alert("‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÅ‡∏ä‡∏ó (TikTok/LINE) ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£/‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß\\n\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î OK ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏ô‡∏π '...' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏•‡∏π‡∏Å‡∏®‡∏£' ‡πÄ‡∏û‡∏∑‡πà‡∏≠ '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå Chrome/Safari' ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡πà‡∏∞!");
    }
})();
</script>
<div class="wrap">
    <div class="card" id="loginCard">
        <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Gx lottery+</h2> 
        <input id="username" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">

        <div class="login-register-buttons">
            <button id="loginBtn"><span>&#8620;</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <a href="#" class="register-btn" id="registerBtn"><span>&#x2795;</span> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
        </div>
    </div>

    <div class="hidden" id="mainApp">
        <header>
            <div class="user-info">
                <strong id="user-name"></strong>
                <button id="logout" class="ghost" style="width:auto;margin-top:0">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </header>

        <div class="main-content">
            <div class="card lotto-panel">
                <h3>‡πÅ‡∏ó‡∏á‡∏´‡∏ß‡∏¢</h3>
                <div style="margin-bottom:15px; display:flex; gap:15px;">
                    <div style="flex:1;">
                        <label class="small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ß‡∏¢</label>
                        <select id="lottoType" style="margin-top:8px">
                            <option value="thai" selected>‡∏´‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢ (1/16)</option>
                            <option value="lao">‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß (‡∏à/‡∏û/‡∏®)</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                         <label class="small">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏á</label>
                        <select id="betType" style="margin-top:8px">
                            </select>
                    </div>
                </div>

                <label class="small">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ó‡∏á)</label>
                <input id="num" type="text" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á" maxlength="3">

                <div style="display:flex;gap:15px;margin-top:15px;align-items:flex-end">
                    <div style="flex:1">
                        <label class="small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input id="amt" type="number" min="1" value="10">
                    </div>
                    <button id="addToCartBtn" style="width:150px;margin-top:0">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                </div>

                <div class="keypad">
                    <button>1</button>
                    <button>2</button>
                    <button>3</button>
                    <button>4</button>
                    <button>5</button>
                    <button>6</button>
                    <button>7</button>
                    <button>8</button>
                    <button>9</button>
                    <button style="grid-column:1 / span 2; background:var(--bg-light)" id="clearBtn">‡∏•‡πâ‡∏≤‡∏á</button>
                    <button>0</button>
                </div>

                <div style="margin-top:30px">
                    <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (<span id="cartCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h4>
                    <div id="cartList" class="tx-list" style="max-height:150px; padding:0 10px;">
                        </div>
                    <div id="cartTotalArea">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                        <span id="cartTotal">0.00 ‡∏ø</span>
                    </div>
                    <button id="payLineBtnForCart" class="success" disabled>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="card" style="margin-bottom:20px">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏¥‡∏•)</h3>
                    <button id="checkResultsBtn" class="success" style="margin-bottom:10px">‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏´‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                    <div class="tx-list">
                        <div id="txs">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                    <a href="#" target="_blank" class="contact-link">‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</a>
                    <a href="#" target="_blank" class="contact-link" style="margin-top:8px">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏≤‡∏á WhatsApp</a>
                </div>

                <div id="adminToolCard" class="card hidden" style="margin-top:20px">
                    <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                    <button id="adminPanelBtn" class="danger">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <div class="hidden" id="adminPanel">
        <div class="card" style="margin:20px auto; max-width:960px;">
            <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Admin Panel)</h2>
            <button id="closeAdminPanel" class="ghost" style="width:auto">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <hr style="margin:20px 0; border-color:var(--border-color);">

            <h3>1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <div id="balanceManagement">
                <div style="display:flex; gap:15px; align-items:flex-end;">
                    <div style="flex:2;">
                        <label class="small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <select id="userToEditSelect"></select>
                    </div>
                    <div style="flex:1;">
                        <label class="small">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö)</label>
                        <input id="balanceAmtInput" type="number" value="100" placeholder="100 ‡∏´‡∏£‡∏∑‡∏≠ -100">
                    </div>
                    <button id="updateBalanceBtn" style="width:150px;margin-top:0">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>
            </div>

            <h3 style="margin-top:30px;">2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏ß‡∏¢ üé±</h3>
            <div id="wnSettings">
                <h4>‡∏´‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢</h4>
                <div style="display:flex; gap:10px;">
                    <div style="flex:3;">
                        <label class="small">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1 (R1 - 6 ‡∏ï‡∏±‡∏ß)</label>
                        <input id="thaiR1" type="text" maxlength="6" placeholder="345898">
                    </div>
                    <div style="flex:1;">
                        <label class="small">‡∏•‡πà‡∏≤‡∏á 2 ‡∏ï‡∏±‡∏ß</label>
                        <input id="thaiL2" type="text" maxlength="2" placeholder="87">
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label class="small">‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß (‡∏ä‡∏∏‡∏î 1)</label>
                        <input id="thaiL3_1" type="text" maxlength="3" placeholder="111">
                    </div>
                    <div style="flex:1;">
                        <label class="small">‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß (‡∏ä‡∏∏‡∏î 2)</label>
                        <input id="thaiL3_2" type="text" maxlength="3" placeholder="690">
                    </div>
                </div>
                
                <h4 style="margin-top:20px;">‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß</h4>
                <div style="display:flex; gap:10px;">
                    <div style="flex:3;">
                        <label class="small">‡∏ú‡∏•‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà (R1 - 6 ‡∏ï‡∏±‡∏ß)</label>
                        <input id="laoR1" type="text" maxlength="6" placeholder="702135">
                    </div>
                    <div style="flex:1;">
                        <label class="small">‡∏•‡πà‡∏≤‡∏á 2 ‡∏ï‡∏±‡∏ß</label>
                        <input id="laoL2" type="text" maxlength="2" placeholder="21">
                    </div>
                </div>
                <div style="flex:1;">
                    <label class="small">3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</label>
                    <input id="laoL3" type="text" maxlength="3" placeholder="135">
                </div>
                <button id="saveWinningNumbersBtn" class="success" style="margin-top:20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
            </div>

            <h3 style="margin-top:30px;">3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏¥‡∏•)</h3>
            <div id="txListAdmin" class="tx-list"></div>
        </div>
    </div>
</div>

<div class="modal" id="qrModal">
    <div class="modal-content">
        <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô: <strong style="color:var(--balance-color); font-size:1.5em;" id="qrAmt">0.00</strong> ‡∏ø</p>
        <p class="small">‡∏£‡∏ß‡∏° <span id="qrNumItems">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>

    <div class="qr-code">
    <img src="truemoney-qr.png" alt="TrueMoney QR Code" style="width:100%; height:100%; display:block;">
</div>
        <p class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" **(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)**</p>
        <button id="notifyTransferBtn" class="success">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
        <button id="closeQrModal" class="ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
</div>

<div class="modal" id="billDetailModal">
    <div class="modal-content" style="max-width:500px">
        <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏¥‡∏• #<span id="billIdDisplay"></span></h3>
        <p class="small" id="billUserTime"></p>
        <hr style="border-color:var(--border-color); margin:10px 0;">
        <div style="max-height:200px; overflow-y:auto; text-align:left;">
            <ul id="billItemsList" style="list-style:none; padding:0; margin:0;">
                </ul>
        </div>
        <div id="billSummary" style="padding-top:10px; margin-top:10px; border-top:1px solid var(--border-color); font-weight:700; display:flex; justify-content:space-between;">
            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
            <span id="billTotalDisplay">0.00 ‡∏ø</span>
        </div>
        <button id="closeBillDetailModal" style="width:100px;margin:15px auto 0 auto">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>


<div class="modal" id="resultModal">
    <div class="card" style="max-width:400px;text-align:center">
        <h3 id="resultHeader"></h3>
        <p id="resultDetails"></p>
        <button id="closeResultModal" style="width:100px;margin:15px auto 0 auto">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const SESS_KEY = 'lotto_session'; // Keep local storage for current login session only

// --- 2. FIREBASE INITIALIZATION (WITH YOUR CONFIG) ---
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyACTSU6LYObSv5gEAfKJt4Yr4LaCCAkQvw",
  authDomain: "goldorax-game.firebaseapp.com",
  databaseURL: "https://goldorax-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "goldorax-game",
  storageBucket: "goldorax-game.firebasestorage.app",
  messagingSenderId: "601999451419",
  appId: "1:601999451419:web:f0782a8437b493eb8f5fbe",
  measurementId: "G-09PW99QK06"
};

// **[‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç]: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® 'database' ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô**
let database; 

// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
    // **[‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç]: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å**
    database = firebase.database(); 
    console.log("Firebase initialized successfully.");
} catch (error) {
    console.error("Error initializing Firebase:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console.");
}

// Global DB References
const usersRef = database.ref('users');
const billsRef = database.ref('bills');
const limitsRef = database.ref('limits');
const wnRef = database.ref('winningNumbers');
// --------------------------------------

// --- CONFIGURATION ---
const ADMIN_USERNAME = 'admin'; 
const ADMIN_PASSWORD = '774570'; 
const INITIAL_BALANCE = 1000.00;

const BET_CONFIG = {
    '3_straight': { name: '3 ‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á', length: 3, payout: 850, limit: 200 }, 
    '3_tod': { name: '3 ‡∏ï‡∏±‡∏ß‡πÇ‡∏ï‡πä‡∏î', length: 3, payout: 120, limit: 150 },
    '2_top': { name: '2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô', length: 2, payout: 95, limit: 200 },
    '2_bottom': { name: '2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á', length: 2, payout: 95, limit: 200 },
    'run_top': { name: '‡∏ß‡∏¥‡πà‡∏á‡∏ö‡∏ô', length: 1, payout: 3, limit: 9999 },
    'run_bottom': { name: '‡∏ß‡∏¥‡πà‡∏á‡∏•‡πà‡∏≤‡∏á', length: 1, payout: 4, limit: 9999 },
};

const DEFAULT_WINNING_NUMBERS = {
    'thai': { 
        name: '‡∏´‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢', 
        R1: '345898', // ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà 1
        L3: ['111', '690'], // ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 3 ‡∏ï‡∏±‡∏ß
        L2: '87', // ‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß
    },
    'lao': {
        name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß',
        R1: '702135', // ‡∏ú‡∏•‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏ç‡πà
        L3: ['135'], // 3 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô
        L2: '21', // 2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á
    }
};

// --- CORE FIREBASE/DATA FUNCTIONS (ASYNC) ---

/**
 * Ensures initial data structure (admin, demo, WN) exists in the database.
 */
async function ensureInitialData() {
    await usersRef.child(ADMIN_USERNAME).once('value', snapshot => {
        if (!snapshot.exists()) {
            usersRef.child(ADMIN_USERNAME).set({ 
                password: ADMIN_PASSWORD, 
                balance: 999999.00
            });
            console.log("Admin user created.");
        }
    });

    await usersRef.child('demo').once('value', snapshot => {
        if (!snapshot.exists()) {
            usersRef.child('demo').set({ 
                password: '123', 
                balance: INITIAL_BALANCE
            });
            console.log("Demo user created.");
        }
    });

    await wnRef.once('value', snapshot => {
        if (!snapshot.exists()) {
            wnRef.set(DEFAULT_WINNING_NUMBERS);
            console.log("Default winning numbers set.");
        }
    });
}

/**
 * Fetches all users data.
 */
async function loadAllUsers() {
    const snapshot = await usersRef.once('value');
    return snapshot.val() || {};
}

/**
 * Fetches user data for the current session.
 */
async function loadCurrentUser() {
    const s = getSession();
    if (!s) return null;
    const snapshot = await usersRef.child(s.username).once('value');
    return snapshot.val();
}

/**
 * Updates a specific user's balance.
 */
async function updateUserBalance(username, newBalance) {
    await usersRef.child(username).update({ balance: newBalance });
}

/**
 * Adds a new bill to the database.
 */
async function addBill(billData) {
    // Generate a unique push key (ID)
    const newBillRef = billsRef.push();
    // Get the key and set it as the bill ID within the object
    billData.id = newBillRef.key;
    await newBillRef.set(billData);
    return newBillRef.key;
}

/**
 * Fetches all bills.
 */
async function loadAllBills() {
    const snapshot = await billsRef.once('value');
    // Convert Firebase object map to an array of bills
    const billsObject = snapshot.val() || {};
    return Object.keys(billsObject).map(key => billsObject[key]);
}

/**
 * Fetches winning numbers.
 */
async function loadWinningNumbers() {
    const snapshot = await wnRef.once('value');
    return snapshot.val() || DEFAULT_WINNING_NUMBERS;
}

/**
 * Saves winning numbers.
 */
async function saveWinningNumbers(wn) {
    await wnRef.set(wn);
}

/**
 * Fetches limits (purchased totals per number).
 */
async function loadLimits() {
    const snapshot = await limitsRef.once('value');
    return snapshot.val() || {};
}

/**
 * Updates limits data.
 */
async function updateLimits(limits) {
    await limitsRef.set(limits);
}

// --- SESSION/CART MANAGEMENT (Kept local) ---
let cart = []; 
function getSession() { return JSON.parse(localStorage.getItem(SESS_KEY) || 'null'); }
function setSession(s) { localStorage.setItem(SESS_KEY, JSON.stringify(s)); }
function clearSession() { localStorage.removeItem(SESS_KEY); }
function getBetName(betType) { return BET_CONFIG[betType] ? BET_CONFIG[betType].name : 'N/A'; }


function getStatusBadge(bill) {
    if (!bill.isPaid) return `<span class="status-badge pending-admin">üü° ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</span>`; 
    if (bill.checked) {
        const anyWin = bill.items.some(item => item.win);
        return `<span class="status-badge ${anyWin ? 'win' : 'lose'}">${anyWin ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : '‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'}</span>`;
    }
    return `<span class="status-badge pending">‚ö™ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>`; 
}

async function renderUserArea() {
    const s = getSession();
    const adminToolCard = $('adminToolCard'); 
    
    if (s) {
        const currentUserData = await loadCurrentUser(); 
        
        if (currentUserData) {
            let userInfoText = `goldoraX - ${s.username}`;
            userInfoText += ` (‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${currentUserData.balance.toFixed(2)} ‡∏ø)`;

            $('user-name').textContent = userInfoText;
            $('loginCard').classList.add('hidden');
            $('mainApp').classList.remove('hidden');

            if (s.username === ADMIN_USERNAME) {
                adminToolCard.classList.remove('hidden');
            } else {
                adminToolCard.classList.add('hidden');
            }
        } else {
             // User not found in DB (e.g., deleted), clear session
            clearSession();
            renderUserArea();
        }
    } else {
        $('loginCard').classList.remove('hidden');
        $('mainApp').classList.add('hidden');
        adminToolCard.classList.add('hidden'); 
    }
}

async function renderTxs() {
    const container = $('txs');
    const bills = await loadAllBills(); 
    const s = getSession();
    if (!s) { container.innerHTML = '<div>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>'; return; }

    // Filter and sort bills for the current user
    const userBills = bills
        .filter(b => b.user === s.username)
        .sort((a, b) => b.time - a.time); // Sort by latest time first

    container.innerHTML = userBills.length === 0 ? '<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</div>' : '';

    userBills.forEach(bill => {
        const el = document.createElement('div');
        el.classList.add('tx-item');
        el.setAttribute('data-bill-id', bill.id);

        let winText = '';
        if (bill.checked && bill.items.some(item => item.win)) {
            const totalPayout = bill.items.reduce((sum, item) => sum + (item.payout || 0), 0);
            winText = `<div style="font-weight:bold; color:var(--deposit-btn-start)">+${totalPayout.toFixed(2)} ‡∏ø</div>`;
        }

        el.innerHTML = `
            <div>
                <div><b>‡∏ö‡∏¥‡∏• #${bill.id.slice(-6)}</b> (${bill.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
                <div class="small">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${bill.totalAmt.toFixed(2)} ‡∏ø | ${new Date(bill.time).toLocaleDateString()}</div>
                ${winText}
            </div>
            ${getStatusBadge(bill)}
        `;
        container.appendChild(el);
    });

    container.querySelectorAll('.tx-item').forEach(el => {
        el.addEventListener('click', (e) => {
            const billId = e.currentTarget.getAttribute('data-bill-id');
            showBillDetailModal(billId);
        });
    });
}

async function showBillDetailModal(billId) {
    const bills = await loadAllBills();
    const bill = bills.find(b => b.id === billId);
    if (!bill) return;

    $('billIdDisplay').textContent = bill.id.slice(-6);
    $('billUserTime').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${bill.user} | ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date(bill.time).toLocaleString()}`;
    $('billTotalDisplay').textContent = bill.totalAmt.toFixed(2) + ' ‡∏ø';

    const list = $('billItemsList');
    list.innerHTML = '';

    const wn = await loadWinningNumbers(); 

    bill.items.forEach(item => {
        const lottoName = (item.lottoType === 'thai' ? wn.thai.name : wn.lao.name);
        const betName = getBetName(item.betType);

        let winStatus = '';
        if (bill.checked) {
            winStatus = item.win ? `<span style="color:var(--deposit-btn-start)"> (+${item.payout.toFixed(2)} ‡∏ø)</span>` : `<span style="color:var(--danger)"> (‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å)</span>`;
        }

        const li = document.createElement('li');
        li.innerHTML = `
            <span style="font-weight:600; color:var(--balance-color)">${item.num}</span> 
            (${betName}, ${lottoName}) x ${item.amt.toFixed(2)} ‡∏ø 
            ${winStatus}
        `;
        list.appendChild(li);
    });

    $('billDetailModal').classList.add('visible');
}


function renderCart() {
    // Cart is local and synchronous
    const container = $('cartList');
    const payLineBtnForCart = $('payLineBtnForCart');
    const cartTotal = cart.reduce((sum, item) => sum + item.amt, 0);

    container.innerHTML = '';
    if (cart.length === 0) {
        container.innerHTML = '<div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>';
        payLineBtnForCart.disabled = true;
    } else {
        cart.forEach((item, index) => {
            const betName = getBetName(item.betType);
            const el = document.createElement('div');
            el.classList.add('cart-item');
            el.innerHTML = `
                <div>${item.num} (${betName}) x ${item.amt.toFixed(2)} ‡∏ø</div>
                <button id="removeCartItem" data-index="${index}" class="danger" style="width:40px;padding:5px;margin:0">X</button>
            `;
            container.appendChild(el);
        });
        payLineBtnForCart.disabled = false;
    }

    payLineBtnForCart.textContent = `‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (${cartTotal.toFixed(2)} ‡∏ø)`;
    $('cartTotal').textContent = `${cartTotal.toFixed(2)} ‡∏ø`;
    $('cartCount').textContent = cart.length;

    container.querySelectorAll('#removeCartItem').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = e.target.getAttribute('data-index');
            cart.splice(index, 1);
            renderCart();
        });
    });
}

function renderBetTypeOptions() {
    const select = $('betType');
    select.innerHTML = ''; 

    const options = [
        { value: '3_straight', text: '3 ‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á (850x)' },
        { value: '3_tod', text: '3 ‡∏ï‡∏±‡∏ß‡πÇ‡∏ï‡πä‡∏î (120x)' },
        { value: '2_top', text: '2 ‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (95x)' },
        { value: '2_bottom', text: '2 ‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (95x)' },
        { value: 'run_top', text: '‡∏ß‡∏¥‡πà‡∏á‡∏ö‡∏ô (3x)' },
        { value: 'run_bottom', text: '‡∏ß‡∏¥‡πà‡∏á‡∏•‡πà‡∏≤‡∏á (4x)' },
    ];

    options.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt.value;
        el.textContent = opt.text;
        select.appendChild(el);
    });
    updateNumberInputConfig();
}

function updateNumberInputConfig() {
    const betType = $('betType').value;
    const config = BET_CONFIG[betType];

    if (config) {
        $('num').setAttribute('maxlength', config.length);
        $('num').value = $('num').value.substring(0, config.length);
        $('num').placeholder = `‡∏Å‡∏£‡∏≠‡∏Å ${config.length} ‡∏´‡∏•‡∏±‡∏Å`;
    }
}

async function renderAll() {
    await renderUserArea();
    await renderTxs();
    renderCart(); // Cart is synchronous
}

// Helper function for checkWin logic
function checkWinLogic(winData, config, num, betType) {
    const numDigits = num.length;
    const R1 = winData.R1; 
    const T3 = R1.slice(-3); 
    const B2 = winData.L2; 
    
    if (numDigits !== config.length) return { win: false, type: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', payout: 0 };

    let isWin = false;
    let winType = config.name;

    switch (betType) {
        case '3_straight': isWin = (num === T3); break;
        case '3_tod': 
            if (num.length === 3) {
                const numArr = num.split('').sort().join('');
                const T3Arr = T3.split('').sort().join('');
                isWin = (numArr === T3Arr);
            }
            break;
        case '2_top': isWin = (num === R1.slice(-2)); break;
        case '2_bottom': isWin = (num === B2); break;
        case 'run_top': isWin = T3.includes(num); break;
        case 'run_bottom': isWin = B2.includes(num); break;
        default: isWin = false; break;
    }

    return { win: isWin, type: winType, payout: isWin ? config.payout : 0 };
}

// --- ADMIN PANEL FUNCTIONS ---

async function showAdminPanel() {
    const s = getSession();
    if (!s || s.username !== ADMIN_USERNAME) {
        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
        return;
    }

    $('mainApp').classList.add('hidden');
    $('adminPanel').classList.remove('hidden');
    await renderAdminPanel();
}

function hideAdminPanel() {
    $('adminPanel').classList.add('hidden');
    $('mainApp').classList.remove('hidden');
    renderAll();
}

async function populateWinningNumbersInputs() {
    const wn = await loadWinningNumbers(); 

    // Thai
    $('thaiR1').value = wn.thai.R1;
    $('thaiL2').value = wn.thai.L2;
    $('thaiL3_1').value = wn.thai.L3[0] || '';
    $('thaiL3_2').value = wn.thai.L3[1] || '';
    
    // Lao
    $('laoR1').value = wn.lao.R1;
    $('laoL2').value = wn.lao.L2;
    $('laoL3').value = wn.lao.L3[0] || '';
}

async function populateUserEditDropdown() {
    const users = await loadAllUsers();
    const select = $('userToEditSelect');
    select.innerHTML = '';
    
    // Filter out the admin user from the list
    Object.keys(users).filter(u => u !== ADMIN_USERNAME).forEach(username => {
        const option = document.createElement('option');
        option.value = username;
        option.textContent = `${username} (‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${users[username].balance.toFixed(2)} ‡∏ø)`;
        select.appendChild(option);
    });

    if (select.children.length === 0) {
        const option = document.createElement('option');
        option.textContent = `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ`;
        select.appendChild(option);
        $('updateBalanceBtn').disabled = true;
    } else {
        $('updateBalanceBtn').disabled = false;
    }
}

async function renderAdminPanel() {
    const txContainer = $('txListAdmin');
    
    // 1. Setup User Editing Dropdown
    await populateUserEditDropdown();

    // 2. Setup Winning Number Inputs
    await populateWinningNumbersInputs();

    // 3. Render Transaction List (Bills)
    const bills = await loadAllBills();
    txContainer.innerHTML = '<h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏¥‡∏•, ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô):</h4>';

    // Sort by latest time first
    bills.sort((a, b) => b.time - a.time).forEach((bill) => {
        
        const billIdShort = bill.id.slice(-6);
        const paidStatusDisplay = bill.isPaid ? 
            `<span style="color:var(--deposit-btn-start); font-weight:bold;">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>` : 
            `<span style="color:var(--danger); font-weight:bold;">üî¥ ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>`;

        const el = document.createElement('div');
        el.classList.add('tx-item');
        el.style.flexDirection = 'column';
        el.style.alignItems = 'flex-start';
        el.innerHTML = `
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <b>‡∏ö‡∏¥‡∏• #${billIdShort}</b> (${bill.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) | ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${bill.totalAmt.toFixed(2)} ‡∏ø
                    <div class="small">${new Date(bill.time).toLocaleString()} ‡πÇ‡∏î‡∏¢ **${bill.user}**</div>
                </div>
                <div style="text-align:right;">${getStatusBadge(bill)}</div>
            </div>
            <div style="margin-top:10px; width:100%; display:flex; justify-content:space-between; align-items:center;">
                <div class="small"><a href="#" onclick="showBillDetailModal('${bill.id}'); event.preventDefault();" style="color:var(--text-main)">[‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢]</a></div>
                <div>${paidStatusDisplay}</div>
            </div>
        `;
        txContainer.appendChild(el);
    });
}

// --- STANDARD EVENT LISTENERS (ASYNC/AWAIT ADDED) ---

// Login
$('loginBtn').addEventListener('click', async () => {
    const u = $('username').value.trim();
    const p = $('password').value.trim();

    if (!u || !p) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }

    const users = await loadAllUsers();

    if (users[u] && users[u].password === p) {
        setSession({ username: u }); 
        await renderAll();
    } else { alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
});

// Register
$('registerBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const u = $('username').value.trim();
    const p = $('password').value.trim();

    if (!u || !p) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }

    const users = await loadAllUsers();
    if (users[u]) {
        alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô');
        return;
    }

    try {
        await usersRef.child(u).set({ 
            password: p, 
            balance: INITIAL_BALANCE
        });
        alert(`‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${u} ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ${INITIAL_BALANCE.toFixed(2)} ‡∏ø)`);
    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ' + error.message);
    }
});


// Logout
$('logout').addEventListener('click', () => {
    clearSession();
    renderAll();
    $('username').value = '';
    $('password').value = '';
});


// ADD TO CART FUNCTION
$('addToCartBtn').addEventListener('click', async () => {
    const s = getSession(); if (!s) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }
    const num = $('num').value.trim();
    const amt = Number($('amt').value) || 0;
    const lottoType = $('lottoType').value;
    const betType = $('betType').value;
    const config = BET_CONFIG[betType];
    
    if (!num || amt <= 0 || num.length !== config.length) { 
        alert(`‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô ${config.length} ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${config.name}`); 
        return; 
    }

    const limits = await loadLimits();
    const limitsKey = `${lottoType}_${betType}_${num}`;
    const currentConfirmedTotal = limits[limitsKey] || 0; 
    const totalInCart = cart.filter(item => item.lottoType === lottoType && item.betType === betType && item.num === num).reduce((sum, item) => sum + item.amt, 0);

    if (currentConfirmedTotal + totalInCart + amt > config.limit) { 
        alert(`‡πÄ‡∏•‡∏Ç ${num} ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${config.name} ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≥‡∏Å‡∏±‡∏î ${config.limit} ‡∏ø)`); 
        return; 
    }
    
    const currentUser = await loadCurrentUser();
    const cartTotal = cart.reduce((sum, item) => sum + item.amt, 0);

    if (currentUser.balance < cartTotal + amt) {
        alert(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏≠! (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${cartTotal + amt} ‡∏ø)`);
        return;
    }

    cart.push({ num, amt, lottoType, betType, timeAdded: Date.now() });
    $('num').value = ''; 
    $('amt').value = 10; 
    renderCart();
    alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${num} (${config.name}) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`);
});


// NOTIFY TRANSFER BUTTON (Simulates Auto-Confirmation)
$('notifyTransferBtn').addEventListener('click', async () => {
    if (cart.length === 0) {
        alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤');
        $('qrModal').classList.remove('visible');
        return;
    }

    const s = getSession();
    if (!s) { $('qrModal').classList.remove('visible'); return; }

    const cartTotal = cart.reduce((sum, item) => sum + item.amt, 0);
    const currentUser = await loadCurrentUser();
    
    // Final balance check before transaction (CRITICAL)
    if (currentUser.balance < cartTotal) {
         alert(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ù‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° ${cartTotal.toFixed(2)} ‡∏ø`);
         $('qrModal').classList.remove('visible');
         return;
    }

    try {
        // 1. Create ONE Bill/Order object
        const newBill = { 
            // ID will be set inside addBill
            user: s.username,
            totalAmt: cartTotal,
            time: Date.now(),
            isPaid: true, 
            checked: false, 
            items: [...cart], 
        };

        // 2. Deduct money AND update current balance
        const newBalance = currentUser.balance - cartTotal;
        await updateUserBalance(s.username, newBalance);

        // 3. Record the ONE Bill
        await addBill(newBill);
        
        // 4. UPDATE LIMITS IMMEDIATELY
        const currentLimits = await loadLimits();
        newBill.items.forEach(item => {
            const limitsKey = `${item.lottoType}_${item.betType}_${item.num}`;
            currentLimits[limitsKey] = (currentLimits[limitsKey] || 0) + item.amt;
        });
        await updateLimits(currentLimits);
        
        // 5. Clear cart
        cart = [];
        $('qrModal').classList.remove('visible');

        // 6. Re-render UI
        await renderAll();

        alert(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ${cartTotal.toFixed(2)} ‡∏ø ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`);
        
    } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ' + error.message);
        $('qrModal').classList.remove('visible');
    }
});


// MANUAL CHECK RESULTS FUNCTION (CRITICAL UPDATE)
$('checkResultsBtn').addEventListener('click', async () => {
    const s = getSession();
    if (!s) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'); return; }

    const bills = await loadAllBills();
    const winningNumbers = await loadWinningNumbers();
    const users = await loadAllUsers();
    let totalWinAmount = 0;
    let newWinsCount = 0;
    let updates = {};

    for (let bill of bills) {
        // Only check bills that are paid and not yet checked
        if (bill.isPaid && !bill.checked) {
            let billTotalPayout = 0;
            let billHasWin = false;

            for (let item of bill.items) {
                const winData = winningNumbers[item.lottoType];
                const config = BET_CONFIG[item.betType];
                const result = checkWinLogic(winData, config, item.num, item.betType); 
                
                // Update item's win status and payout
                item.win = result.win;
                item.payout = result.win ? (item.amt * result.payout) : 0;
                
                if (result.win) {
                    billTotalPayout += item.payout;
                    billHasWin = true;
                }
            }

            bill.checked = true;

            if (billHasWin) {
                totalWinAmount += billTotalPayout;
                newWinsCount++;
                
                // Update user balance (in local copy of users object)
                if (users[bill.user]) {
                    users[bill.user].balance = (users[bill.user].balance || 0) + billTotalPayout;
                    updates[`users/${bill.user}/balance`] = users[bill.user].balance;
                }
            }
            
            // Prepare update path for the bill (using bill.id which was set in addBill)
            updates[`bills/${bill.id}`] = bill;
        }
    }

    if (Object.keys(updates).length > 0) {
        // Multi-path update for efficiency
        await database.ref().update(updates); 
        
        if (newWinsCount > 0) {
            alert(`‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏´‡∏ß‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ö‡∏¥‡∏•‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${newWinsCount} ‡∏ö‡∏¥‡∏•\\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏£‡∏ß‡∏° ${totalWinAmount.toFixed(2)} ‡∏ø\\n(‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß)`);
        } else {
            alert('‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏´‡∏ß‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏µ‡πâ');
        }
    } else {
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏• (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)');
    }

    await renderAll();
});


// --- ADMIN ACTION FUNCTIONS ---

// Function to save WN
$('saveWinningNumbersBtn').addEventListener('click', async () => {
    const newThaiR1 = $('thaiR1').value.trim();
    const newThaiL2 = $('thaiL2').value.trim();
    const newThaiL3_1 = $('thaiL3_1').value.trim();
    const newThaiL3_2 = $('thaiL3_2').value.trim();
    const newLaoR1 = $('laoR1').value.trim();
    const newLaoL2 = $('laoL2').value.trim();
    const newLaoL3 = $('laoL3').value.trim();

    if (newThaiR1.length !== 6 || newThaiL2.length !== 2 || newThaiL3_1.length !== 3 || newThaiL3_2.length !== 3 || newLaoR1.length !== 6 || newLaoL2.length !== 2 || newLaoL3.length !== 3) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î');
        return;
    }

    const newWN = {
        'thai': { 
            name: '‡∏´‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢', 
            R1: newThaiR1, 
            L3: [newThaiL3_1, newThaiL3_2], 
            L2: newThaiL2, 
        },
        'lao': {
            name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß',
            R1: newLaoR1, 
            L3: [newLaoL3], 
            L2: newLaoL2, 
        }
    };

    try {
        await saveWinningNumbers(newWN);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        await populateWinningNumbersInputs(); 
    } catch (error) {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
    }
});

// Function to update user balance
$('updateBalanceBtn').addEventListener('click', async () => {
    const selectedUser = $('userToEditSelect').value;
    const amount = Number($('balanceAmtInput').value);

    if (!selectedUser || isNaN(amount) || amount === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
    }

    const users = await loadAllUsers();
    
    if (users[selectedUser]) {
        const newBalance = (users[selectedUser].balance || 0) + amount;
        
        try {
            await updateUserBalance(selectedUser, newBalance);
            alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${selectedUser} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏∑‡∏≠ ${newBalance.toFixed(2)} ‡∏ø`);
            $('balanceAmtInput').value = 100; // Reset input

            // Re-render UI
            await renderAdminPanel(); 
            await renderAll();
        } catch (error) {
            alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
        }

    } else {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
    }
});


// Close Modals (Standard)
$('payLineBtnForCart').addEventListener('click', () => {
    if (cart.length === 0) return;
    const cartTotal = cart.reduce((sum, item) => sum + item.amt, 0);
    $('qrAmt').textContent = cartTotal.toFixed(2);
    $('qrNumItems').textContent = cart.length;
    $('qrModal').classList.add('visible');
});
$('closeQrModal').addEventListener('click', () => { $('qrModal').classList.remove('visible'); });
$('closeBillDetailModal').addEventListener('click', () => { $('billDetailModal').classList.remove('visible'); });
$('closeResultModal').addEventListener('click', () => { $('resultModal').classList.remove('visible'); });
$('adminPanelBtn').addEventListener('click', showAdminPanel);
$('closeAdminPanel').addEventListener('click', hideAdminPanel);
$('betType').addEventListener('change', updateNumberInputConfig);
document.querySelectorAll('.keypad button').forEach(btn => {
    btn.addEventListener('click', () => {
        const numInput = $('num');
        const config = BET_CONFIG[$('betType').value];
        const maxLength = config ? config.length : 1; 

        if (btn.id === 'clearBtn') {
            numInput.value = '';
        } else if (numInput.value.length < maxLength) {
            numInput.value += btn.textContent;
        }
    });
});


// Initial Setup (Async)
(async function init() {
    await ensureInitialData();
    renderBetTypeOptions(); 
    await renderAll();
})();
</script>
</body>
</html>
